<!DOCTYPE html>
<html lang="vi">

<head>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAA">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th√¥ng tin ng∆∞·ªùi d√πng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Roboto:wght@400;700&display=swap"
        rel="stylesheet">
        <link rel="stylesheet" href="../css/profile.css">
</head>

<body>
    <div class="bg-art">
        <div class="circle circle1"></div>
        <div class="circle circle2"></div>
        <div class="circle circle3"></div>
        <div class="circle circle4"></div>
        <div class="circle circle5"></div>
    </div>
    <div class="container">
        <div class="profile-header">
            <h2>Th√¥ng tin t√†i kho·∫£n</h2>
        </div>
        <div class="avatar-container">
            <img id="profile-avatar" src="../asset/image/Material/user.jpg" alt="User Avatar" class="avatar-img">
            <input type="file" id="file-input" style="display: none;" accept="image/*">
        </div>
        <form id="profileForm">
            <div class="mb-3">
                <label for="username" class="form-label">T√™n ng∆∞·ªùi d√πng</label>
                <input type="text" class="form-control" id="username" readonly>
            </div>
            <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" readonly>
            </div>
            <button type="button" id="change-avatar-btn" class="btn btn-secondary w-100 mb-3">
                <i class="fas fa-camera"></i> ƒê·ªïi Avatar
            </button>
            <button type="submit" id="save-btn" class="btn btn-primary w-100 mb-3">
                <span class="btn-text">
                    <i class="fas fa-save"></i> L∆∞u thay ƒë·ªïi
                </span>
                <span class="btn-loading" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i l√™n...
                </span>
            </button>
            <div id="message" class="alert d-none" role="alert"></div>
            <a href="/html/web.html" class="btn btn-secondary w-100">Quay l·∫°i trang ch√≠nh</a>
        </form>
    </div>

    <script src="../js/core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const avatarImg = document.getElementById('profile-avatar');
            const fileInput = document.getElementById('file-input');
            const changeAvatarBtn = document.getElementById('change-avatar-btn');
            const profileForm = document.getElementById('profileForm');
            const usernameInput = document.getElementById('username');
            const emailInput = document.getElementById('email');
            const messageDiv = document.getElementById('message');

            let user = window.Core.getUser();
            const token = window.Core.getToken();

            if (user && token) {
                usernameInput.value = user.username;
                emailInput.value = user.email;
                
                // Explicitly set profile avatar
                if (user.avatar) {
                    avatarImg.src = user.avatar.startsWith('http') ? user.avatar : `${window.location.origin}${user.avatar}`;
                } else {
                    avatarImg.src = '../asset/image/Material/user.jpg';
                }
                
                // Add error handling for profile avatar
                avatarImg.onerror = function() {
                    console.log('Profile avatar failed to load, using default');
                    this.src = '../asset/image/Material/user.jpg';
                    this.onerror = null; // Prevent infinite loop
                };
            } else {
                // If no user, set default avatar and redirect
                avatarImg.src = '../asset/image/Material/user.jpg';
                window.location.href = 'sign_in.html';
            }

            changeAvatarBtn.addEventListener('click', () => {
                // Clear any previous messages
                messageDiv.classList.add('d-none');
                fileInput.click();
            });
            
            // Also allow clicking on avatar to change it
            avatarImg.addEventListener('click', () => {
                messageDiv.classList.add('d-none');
                fileInput.click();
            });

            let newAvatarFile = null;

            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        messageDiv.textContent = 'Vui l√≤ng ch·ªçn file ·∫£nh h·ª£p l·ªá.';
                        messageDiv.className = 'alert alert-danger mt-3';
                        messageDiv.classList.remove('d-none');
                        return;
                    }
                    
                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        messageDiv.textContent = 'K√≠ch th∆∞·ªõc file kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB.';
                        messageDiv.className = 'alert alert-danger mt-3';
                        messageDiv.classList.remove('d-none');
                        return;
                    }
                    
                    newAvatarFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        avatarImg.src = e.target.result;
                        console.log('New avatar preview loaded successfully');
                    };
                    reader.onerror = (e) => {
                        console.error('Error reading file:', e);
                        messageDiv.textContent = 'L·ªói khi ƒë·ªçc file ·∫£nh.';
                        messageDiv.className = 'alert alert-danger mt-3';
                        messageDiv.classList.remove('d-none');
                    };
                    reader.readAsDataURL(file);
                    
                    messageDiv.textContent = '·∫¢nh ƒë·∫°i di·ªán ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t. Nh·∫•n "L∆∞u thay ƒë·ªïi" ƒë·ªÉ x√°c nh·∫≠n. üì∑';
                    messageDiv.className = 'alert alert-info mt-3';
                    messageDiv.classList.remove('d-none');
                }
            });

            profileForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                
                const saveBtn = document.getElementById('save-btn');
                const btnText = saveBtn.querySelector('.btn-text');
                const btnLoading = saveBtn.querySelector('.btn-loading');
                const avatarContainer = document.querySelector('.avatar-container');
                
                if (!newAvatarFile) {
                    messageDiv.textContent = 'Kh√¥ng c√≥ ·∫£nh m·ªõi ƒë·ªÉ l∆∞u. Vui l√≤ng ch·ªçn ·∫£nh tr∆∞·ªõc.';
                    messageDiv.className = 'alert alert-info mt-3';
                    messageDiv.classList.remove('d-none');
                    return;
                }

                // Start loading state
                saveBtn.disabled = true;
                btnText.style.display = 'none';
                btnLoading.style.display = 'flex';
                avatarContainer.classList.add('loading');
                messageDiv.classList.add('d-none');

                const formData = new FormData();
                formData.append('avatar', newAvatarFile);

                try {
                    const response = await fetch('/api/upload-avatar', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Update user avatar immediately
                        user.avatar = data.url;
                        window.Core.setUser(user);
                        
                        // Update avatar display immediately
                        avatarImg.src = data.url.startsWith('http') ? data.url : `${window.location.origin}${data.url}`;
                        window.Core.updateHeaderAvatar();
                        
                        // Success state
                        messageDiv.textContent = '·∫¢nh ƒë·∫°i di·ªán ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng! üéâ';
                        messageDiv.className = 'alert alert-success mt-3';
                        messageDiv.classList.remove('d-none');
                        
                        // Reset form state
                        newAvatarFile = null;
                        fileInput.value = '';
                        
                        console.log('Avatar updated successfully:', data.url);
                        console.log('User data saved:', user);
                        
                        // No reload needed - avatar is already updated
                    } else {
                        throw new Error(data.error || 'Kh√¥ng th·ªÉ t·∫£i l√™n ·∫£nh ƒë·∫°i di·ªán.');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    messageDiv.textContent = `L·ªói: ${error.message}`;
                    messageDiv.className = 'alert alert-danger mt-3';
                    messageDiv.classList.remove('d-none');
                } finally {
                    // Always reset loading state
                    saveBtn.disabled = false;
                    btnText.style.display = 'flex';
                    btnLoading.style.display = 'none';
                    avatarContainer.classList.remove('loading');
                }
            });
        });
    </script>
</body>

</html>